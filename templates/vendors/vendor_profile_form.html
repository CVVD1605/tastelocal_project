{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-5">
  <div class="row">

    <!-- Sidebar -->
    <div class="col-md-3 mb-4">
      <div class="list-group">
        <a href="#" class="list-group-item list-group-item-action active">Dashboard Home</a>
        <a href="{% url 'vendor-booking-list' %}" class="list-group-item list-group-item-action">View Bookings</a>
        <a href="{% url 'vendor-fooditem-list' %}" class="list-group-item list-group-item-action">Manage Food Items</a>
        <a href="{% url 'vendor-profile-edit' %}" class="list-group-item list-group-item-action">Edit Profile</a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
      <h2 class="mb-4">
        {% if form.instance.pk %}Edit Vendor Profile{% else %}Set Up Your Vendor Profile{% endif %}
      </h2>

      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {% for field in form %}
          {% if field.name != 'location_text' and field.name != 'latitude' and field.name != 'longitude' %}
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              {{ field|add_class:"form-control" }}
              {% if field.errors %}
                <div class="text-danger small">{{ field.errors }}</div>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}

        <!-- Address Autocomplete -->
        <div class="mb-3">
          <label for="autocomplete" class="form-label">Business Address</label>
          <input type="text" id="autocomplete" name="location_text" value="{{ form.location_text.value }}" class="form-control" placeholder="Start typing your address..." required>
        </div>

        <!-- Hidden Lat/Lng Fields -->
        <input type="hidden" id="latitude" name="latitude" value="{{ form.latitude.value }}">
        <input type="hidden" id="longitude" name="longitude" value="{{ form.longitude.value }}">

        <!-- Map Display -->
        <div class="mb-4">
          <div id="map" style="height: 300px;"></div>
        </div>

        <button type="submit" class="btn btn-primary">
          {% if form.instance.pk %}Save Changes{% else %}Create Profile{% endif %}
        </button>
        <a href="{% url 'vendor-dashboard' %}" class="btn btn-secondary">Cancel</a>
      </form>
    </div>
  </div>
</div>

<!-- Google Maps Script -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmp0o55ZLJ-KiyGFalWq1H9VIG8Lzyz7w&libraries=places"></script>
<script>
  let map, marker;

  function initMap() {
    const defaultLatLng = { lat: 1.3521, lng: 103.8198 }; // Singapore

    const mapOptions = {
      center: defaultLatLng,
      zoom: 12,
    };

    map = new google.maps.Map(document.getElementById("map"), mapOptions);

    const input = document.getElementById("autocomplete");
    const autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo("bounds", map);

    autocomplete.addListener("place_changed", () => {
      const place = autocomplete.getPlace();
      if (!place.geometry) return;

      map.setCenter(place.geometry.location);
      map.setZoom(15);

      if (marker) marker.setMap(null);
      marker = new google.maps.Marker({
        map: map,
        position: place.geometry.location,
      });

      document.getElementById("latitude").value = place.geometry.location.lat();
      document.getElementById("longitude").value = place.geometry.location.lng();
    });

    // Pre-fill marker if lat/lng exists
    const lat = parseFloat(document.getElementById("latitude").value);
    const lng = parseFloat(document.getElementById("longitude").value);
    if (!isNaN(lat) && !isNaN(lng)) {
      const position = { lat: lat, lng: lng };
      marker = new google.maps.Marker({ map, position });
      map.setCenter(position);
      map.setZoom(15);
    }
  }

  window.onload = initMap;
</script>
{% endblock %}
